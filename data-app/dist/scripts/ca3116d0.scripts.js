"use strict";var valenceApp=angular.module("valence",[]);valenceApp.run(["route","auth","acl","model",function(){}]),window.valence={},valence.models=[],valence.model=function(a,b){for(var c=!1,d={},e=0;e<valence.models.length;e++)valence.models[e].name===a&&(c=!0);if(!c){d.name=a;for(var f in b)d[f]=b[f];valence.models.push(d)}},valence.roles=[],valence.role=function(a,b){for(var c=0;c<valence.roles.length;c++)if(valence.roles[c].name===a)throw"Valence - ACL: You cannot register two or more roles with the same name.";valence.roles.push({name:a,fn:b})},valenceApp.provider("valence",{route:{},loader:{},models:[],roles:[],cloud:{},store:{},acl:{identity:{}},auth:{endpoints:{login:{},logout:{},validate:{}}},storageEngine:{primary:"localStorage",fallbackToMemory:!0},$get:["$route",function(){return this.model=valence.model,this.models=valence.models,this.role=valence.role,this.roles=valence.roles,valence=this,this}]}),valenceApp.service("model",["valence","cloud","store","loader","auth","$route","$rootScope","$location","$rootElement","$q","$routeParams","route",function(a,b,c,d,e,f,g,h,i,j,k){function l(b){for(var c,d=0;d<a.models.length;d++)a.models[d].name===b&&(c=a.models[d]);if(!c&&opts)c=opts;else if(!c&&!opts)throw"Valence - model for ["+b+"] not found. Make sure to declare one through valence.model()";return c}function m(a,b){for(var c in b)try{a[c]=b[c].constructor===Object?r.fn.merge(a[c],b[c]):b[c]}catch(d){a[c]=b[c]}return a}function n(b){for(var c,e,f=0;f<a.models.length;f++)a.models[f].name===b.model&&(b.scope=a.models[f].scope);c=b.scope||g,e=o(b.opts,b.data),b.opts.normalize?b.opts.normalize(a,b,e,j).then(function(a){b.opts.skipApply||(c[b.model]=a),b.def.resolve(a),d.loaded(b.model)}):(b.opts.skipApply||(c[b.model]=e),b.def.resolve(e),d.loaded(b.model))}function o(a,b){var c,d=Array,e={Array:function(a){return[a]},Object:function(a){var b={};if(a.constructor!==Array&&(a=[a]),1===a.length)b=a[0];else for(var c=0;c<a.length;c++)b[c]=a[c];return b},String:function(a){return a.toString()},Boolean:function(a){return!!a}};return d=p(a.type?a.type:a.belongsTo&&a.belongsTo.type?a.belongsTo.type:d),null===b.constructor.toString().match(d)?e[d]&&(c=e[d](b)):c=b,c}function p(a){for(var b=["Array","String","Boolean","Object"],c=!1,d=0;d<b.length;d++)a.toString().match(b[d])&&(c=b[d]);return c}function q(b,c){if(c[b].model){c[b].model.constructor!==Array&&(c[b].model=[c[b].model]);for(var e=0;e<c[b].model.length;e++)for(var f=0;f<a.models.length;f++)a.models[f].name===c[b].model[e]&&a.get(a.models[f].name,a.models[f])}else d.finish()}a.utils={},a.utils.safeApply=function(a,b){var c=setInterval(function(){var d=a.$$phase;"$apply"!=d&&"$digest"!=d&&(clearInterval(c),a.$apply(b))},100)},a.buildParamQuery=function(a){var b,c={};if(a&&(a.by?b=["by"]:a.params&&!a.data?b=["params"]:a.data&&!a.params?b=["data"]:a.params&&a.data&&(b=["params","data"])),b)for(var d=0;d<b.length;d++)for(var e in a[b[d]])c[b[d]]||(c[b[d]]={}),k[e]&&("params"==b[d]?c[b[d]][e]=k[e]:c[b[d]][a[b[d]][e]]=k[e]),a.useRouteParams===!1&&(c[b[d]][e]=a[b[d]][e]);return Object.keys(c).length?c:!1};var r=function(e,f){var g=this,h={loader:!0,belongsTo:null,hasMany:null,localize:!0,forceFetch:!1,ignoreDefaultConfig:!1,storeInMemory:!1,refreshModel:!0,skipApply:!1,auth:!1};this.opts=f.opts?f.opts.ignoreDefaultConfig?f.opts:m(h,m(l(f.model),f.opts)):m(h,l(f.model)),this.args={},this.args.action=e,this.args.model=f.model,this.args.opts=this.opts,this.args.data=f.data,this.args.def=f.def,this.strategeries=[],this.sequences={},this.sequences.GET={},this.sequences.GET.save=[{fn:c.set,fail:g.halt,pass:g.conquer,overriden:g.conquer,overrides:[!g.opts.localize],name:"store.set"}],this.sequences.GET.cloud=[{fn:b.get,fail:g.halt,pass:this.sequences.GET.save,name:"cloud.get"}],this.sequences.GET.store=[{fn:c.get,fail:this.sequences.GET.cloud,pass:g.conquer,overrides:[g.opts.forceFetch],overriden:this.sequences.GET.cloud,name:"store.get"}],this.sequences.GET.init=[{fn:d.run,pass:this.sequences.GET.store,overrides:[!a.loader.enabled],name:"loader.run"}],this.sequences.POST={},this.sequences.POST.store=[{fn:c.set,fail:g.halt,pass:g.conquer,overriden:g.conquer,overrides:[!g.opts.localize],name:"store.set"}],this.sequences.POST.fetch=[{fn:b.get,fail:g.halt,pass:this.sequences.POST.store,name:"cloud.get",overriden:this.sequences.POST.store,overrides:[!g.opts.refreshModel]}],this.sequences.POST.cloud=[{fn:b.set,fail:g.halt,pass:this.sequences.POST.fetch,name:"cloud.set",overrides:[g.opts.ignoreOrigin],overriden:this.sequences.POST.store}],this.sequences.POST.init=[{fn:d.run,pass:g.sequences.POST.cloud,overrides:[!a.loader.enabled],name:"loader.run"}],this.sequences.PUT=this.sequences.POST,this.sequences.DELETE={},this.sequences.DELETE.store=[{fn:c.set,fail:g.halt,pass:g.conquer,overriden:g.conquer,overrides:[!g.opts.localize],name:"store.set"}],this.sequences.DELETE.fetch=[{fn:b.get,fail:g.halt,pass:this.sequences.DELETE.store,name:"cloud.get"}],this.sequences.DELETE.cloud=[{fn:b.remove,fail:g.halt,pass:this.sequences.DELETE.fetch,name:"cloud.set"}],this.sequences.DELETE.init=[{fn:d.run,pass:g.sequences.DELETE.cloud,overrides:[!a.loader.enabled],name:"loader.run"}],this.advance()};return r.prototype.advance=function(){var a,b=this;a=this.sequences[this.args.action].init,function c(a,d){if(d=d||0,a=a[d],a.overrides)a:for(var e=0;e<a.overrides.length;e++)if(a.overrides[e]){if(a.overriden)return a.overriden.constructor===Function?a.overriden(b.args):c(a.overriden);break a}a.fn(b.args).then(function(e){return e&&(b.args.data=e),a.pass?a.pass.constructor===Function?a.pass(b.args):c(a.pass):a[d+1]?c(a,d+1):void 0},function(e){return e&&(b.args.data=e),a.fail?a.fail.constructor===Function?a.fail(b.args,e):c(a.fail):a[d+1]?c(a,d+1):void 0})}(a)},r.prototype.conquer=function(a){n(a)},r.prototype.halt=function(a,b){a.def.reject({args:a,data:b}),d.halt()},a.get=function(a,b){var c=j.defer();return b=b||{},new r("GET",{model:a,opts:b.opts,data:b.data,def:c}),c.promise},a.put=function(a,b){var c=j.defer();return new r("PUT",{model:a,opts:b.opts,data:b.data,def:c}),c.promise},a.post=function(a,b){var c=j.defer();return new r("POST",{model:a,opts:b.opts,data:b.data,def:c}),c.promise},a.remove=function(a,b){var c=j.defer();return new r("DELETE",{model:a,opts:b.opts,data:b.data,def:c}),c.promise},a.scope=function(b,c){b=b.constructor===Array?b:[b];for(var d=0;d<b.length;d++)for(var e=0;e<a.models.length;e++)a.models[e].name===b[d]&&(a.models[e].scope=c)},g.save=a.post,g.update=a.put,g.remove=a.remove,a.route.addHook(q),a}]),valenceApp.service("loader",["valence","$q",function(a,b){return a.loader.queue=[],a.loader.loaderStarted=null,a.loader.loaderClasses={hide:a.loader.classes&&a.loader.classes.hide?a.loader.classes.hide:"ngLoader-hidden",show:a.loader.classes&&a.loader.classes.show?a.loader.classes.show:"ngLoader-visible"},a.loader.loaderCollection=[],a.loader.contentCollection=[],a.loader.minLoaderDisplayTime=250,a.loader.run=function(c,d){var e,f=b.defer(),g=a.loader.content,h=a.loader.loader;if(a.loader.enabled){c&&(c=c.model||c,d=c.opts||d,e=c.data,a.loader.queue.push({name:c,opts:d}),c.loader&&(d.loader.content&&(g=d.loader.content),d.loader.loader&&(h=d.loader.loader))),a.loader.loaderStarted||(a.loader.loaderStarted=(new Date).getTime()),g=document.querySelectorAll(g).length?document.querySelectorAll(g):function(){throw"valence - ngLoader - It was requested that ["+g+"] be hidden when initiating the loader, however, no elements could be found in the DOM"}(),h=document.querySelectorAll(h).length?document.querySelectorAll(h):function(){throw"valence - ngLoader - It was requested that ["+h+"] be hidden when initiating the loader, however, no elements could be found in the DOM"}();for(var i=0;i<g.length;i++)g[i].classList.add(a.loader.loaderClasses.hide),g[i].classList.remove(a.loader.loaderClasses.show),a.loader.contentCollection.push(g[i]);for(var i=0;i<h.length;i++)h[i].classList.add(a.loader.loaderClasses.show),h[i].classList.remove(a.loader.loaderClasses.hide),a.loader.loaderCollection.push(h[i])}return f.resolve(e),f.promise},a.loader.loaded=function(b){var c=[];if(!b)throw'valence - ngLoader - valence.loader.loaded must be passed a model so it knows how "done" it is and when to stop the loader.';for(var d=0;d<a.loader.queue.length;d++)b!==a.loader.queue[d].name&&c.push(a.loader.queue[d]);a.loader.queue=c,a.loader.finish()},a.loader.finish=function(){var b,c=a.loader;a.loader.queue.length||(b=(new Date).getTime(),b-a.loader.loaderStarted>=a.loader.minLoaderDisplayTime?a.loader.wrapUp():setTimeout(function(){c.wrapUp()},c.minLoaderDisplayTime-(b-c.loaderStarted)),a.loader.loaderStarted=null)},a.loader.wrapUp=function(){if(a.loader.enabled){a.loader.contentCollection.length||(a.loader.contentCollection=document.querySelectorAll(a.loader.content).length?document.querySelectorAll(a.loader.content):function(){throw"valence - ngLoader - It was requested that ["+a.loader.content+"] be hidden when initiating the loader, however, no elements could be found in the DOM"}()),a.loader.loaderCollection.length||(a.loader.loaderCollection=document.querySelectorAll(a.loader.loader).length?document.querySelectorAll(a.loader.loader):function(){throw"valence - ngLoader - It was requested that ["+a.loader.loader+"] be hidden when initiating the loader, however, no elements could be found in the DOM"}());for(var b=0;b<a.loader.loaderCollection.length;b++)a.loader.loaderCollection[b].classList.remove(a.loader.loaderClasses.show),a.loader.loaderCollection[b].classList.add(a.loader.loaderClasses.hide);for(var b=0;b<a.loader.contentCollection.length;b++)a.loader.contentCollection[b].classList.remove(a.loader.loaderClasses.hide),a.loader.contentCollection[b].classList.add(a.loader.loaderClasses.show);a.loader.loaderCollection=[],a.loader.contentCollection=[]}},a.loader.halt=function(){a.loader.queue=[],a.loader.finish()},a.loader}]),valenceApp.service("store",["valence","$q",function(a,b){var c=window.valenceStore={},d={};d.localStorage={get:function(){var a,b=JSON.parse(window.localStorage.valenceStore);return b.hasOwnProperty(args.model)&&(a=b[args.model]),a},set:function(a,b){var c=JSON.parse(window.localStorage.valenceStore);return c[args.model]=b,window.localStorage.valenceStore=JSON.stringify(c),this.get(args.model)},remove:function(a){var b=JSON.parse(window.localStorage.valenceStore);return b.hasOwnProperty(a)?(delete b[args.model],window.localStorage.valenceStore=JSON.stringify(b),!0):!1}},d.memory={get:function(a){var b;return c.hasOwnProperty(a)&&(b=c[a]),b},set:function(a,b){return c[a]=b,this.get(a)},remove:function(a){return c.hasOwnProperty(a)?(delete c[a],!0):!1}},a.store={};var e=a.storageEngine&&a.storageEngine.primary?a.storageEngine.primary:a.storageEngine&&a.storageEngine.fallbackToMemory?"memory":window.localStorage?"localStorage":[];return"localStorage"===e&&(a.storageEngine.fetchOnReload||void 0===window.localStorage.valenceStore)&&(window.localStorage.valenceStore=JSON.stringify({})),a.store.get=function(c){var f,g=b.defer(),h=d[e].get(c.model),i=0,j=0;if((c.opts&&c.opts.localize===!1||c.opts.forceFetch===!0)&&g.reject("store"),h)if(c.opts.belongsTo&&(c.query=a.buildParamQuery(c.opts.belongsTo)),c.query){for(var k in c.query)for(var l in c.query[k])i++;if(h.constructor===Array){f=[];for(var m=0;m<h.length;m++){if(h[m].constructor===Object)for(var k in c.query)for(var l in c.query[k])h[m][l]&&h[m][l]==c.query[k][l]&&(j++,i&&j&&i===j&&-1===f.indexOf(h[m])&&f.push(h[m]));j=0}f.length?g.resolve(f):g.reject(f)}else if(h.constructor===Object){for(var k in c.query)for(var l in c.query[k])i++,h[l]&&h[l]===c.query[k][l]&&j++;i&&j&&i===j?g.resolve(h):g.reject(h)}}else g.resolve(h);else g.reject(!1);return g.promise},a.store.set=function(a){var c,f=b.defer();return a.opts&&a.opts.localize===!1?f.resolve(a.data):(c=d[e].set(a.model,a.data),c?f.resolve(c):f.reject(!1)),f.promise},a.store.remove=function(a){var c=b.defer();return d[e].remove(a.model)?c.resolve(!0):c.reject(!1),c.promise},a.store}]),valenceApp.service("cloud",["valence","$http","$q",function(a,b,c){var d=a.api+"/";return a.cloud.get=function(e){var f=c.defer(),g={};return g.method="GET",g.url=d+e.model,g.params=null,e.opts.HTTP&&e.opts.HTTP.GET?(e.opts.HTTP.GET.params?e.query=a.buildParamQuery(e.opts.HTTP.GET):e.opts.belongsTo&&(e.query=a.buildParamQuery(e.opts.belongsTo)),e.opts.HTTP.GET.url&&(g.url=d+e.opts.HTTP.GET.url),e.opts.HTTP.GET.auth&&!a.auth.isValidated&&f.reject()):e.opts.belongsTo&&(e.query=a.buildParamQuery(e.opts.belongsTo)),e.query&&(g.params=e.query.params||e.query.by),b(g).success(function(a){f.resolve(a)}).error(function(a,b,c,d){f.reject({data:a,status:b,headers:c,config:d})}),f.promise},a.cloud.set=function(e){var f,g=c.defer(),h={};if(f=e.action.toUpperCase(),h.method=f,h.url=d+e.model,h.params=null,e.opts.HTTP&&e.opts.HTTP[f]&&(e.query=a.buildParamQuery(e.opts.HTTP[f]),e.opts.HTTP[f].url&&(h.url=d+e.opts.HTTP[f].url)),e.query&&e.query.params&&(h.params=e.query.params),h.data=e.data,e.query&&e.query.data)for(var i in e.query.data)h.data[i]=e.query.data[i];return b(h).success(function(a){g.resolve(a)}).error(function(a,b,c,d){g.reject({data:a,status:b,headers:c,config:d})}),g.promise},a.cloud}]),valenceApp.service("auth",["valence","$rootScope","$location","$route","$http","$routeParams","$q","route",function(a,b,c,d,e,f,g){function h(b,c){var d;(c[b].auth||a.auth.every)&&(c[b].auth&&c[b].auth.redirect&&(d=c[b].auth.redirect),a.auth.validate(c[b],d))}a.auth.every=!0,a.auth.isValidated=null,a.auth.lastValidated=null,a.auth.validateInterval=1e4,a.auth.firstVisit=!0,a.auth.token=a.auth.endpoints.validate.name||null;var i=a.auth.storage||"localStorage";if(a.auth.validate=function(b,d){var f=this,i=g.defer();if((new Date).getTime()-a.auth.lastValidated>a.auth.validateInterval||null===a.auth.lastValidated)f.getToken()&&!e.defaults.headers.common.authorization&&(e.defaults.headers.common.authorization="Bearer "+f.getToken()),e({method:a.auth.endpoints.validate.method,url:a.auth.endpoints.validate.URL,withCredentials:!0}).success(function(){f.postFlow({isValidated:!0,lastValidated:(new Date).getTime()}),a.acl.getIdentity().then(function(a){i.resolve(a)}),b?d&&d.success&&c.path(d.success):a.route.parseRoutes(h)}).error(function(){d&&d.fail&&c.path(d.fail),f.postFlow({isValidated:!1,lastValidated:(new Date).getTime()}),a.acl.getIdentity().then(function(a){i.reject(a)})});else{if(!b)return a.route.parseRoutes(h);a.auth.isValidated&&d&&d.success?c.path(d.success):!a.auth.isValidated&&d&&d.fail&&c.path(d.fail),a.acl.getIdentity().then(function(a){i.reject(a)})}return i.promise},a.auth.login=function(b){var d=this,f=g.defer();if(!b)throw"Valence - Auth - you must provide credentials to this method [login].";return e({method:a.auth.endpoints.login.method,url:a.auth.endpoints.login.URL,data:b}).success(function(b){var e=b[a.auth.token]?b[a.auth.token]:b;d.postFlow({isValidated:!0,setToken:e}),a.acl.getIdentity().then(function(a){f.resolve(a)}),a.auth.endpoints.login.success&&c.path(a.auth.endpoints.login.success)}).error(function(){d.postFlow({isValidated:!1,setToken:null}),a.acl.getIdentity().then(function(a){f.resolve(a)}),a.auth.endpoints.login.fail&&c.path(a.auth.endpoints.fail)}),f.promise},a.auth.logout=function(){var b=this,d=g.defer();return b.postFlow({isValidated:!1,setToken:null}),c.path(a.auth.endpoints.logout.success),a.acl.clearIdentity().then(function(a){d.resolve(a)}),d.promise},a.auth.postFlow=function(a){var b=this;for(var c in a)b[c]&&b[c].constructor===Function?b[c](a[c]):b[c]=a[c]},a.auth.setToken=function(b){var c=this;"localStorage"===i?window.localStorage[a.auth.token]=b:"sessionStorage"===i&&(window.sessionStorage[a.auth.token]=b),b?e.defaults.headers.common.authorization="Bearer "+c.getToken():delete e.defaults.headers.common.authorization},a.auth.getToken=function(){var b=null;return"localStorage"===i?b=window.localStorage[a.auth.token]:"sessionStorage"===i&&(b=window.sessionStorage[a.auth.token]),b},a.auth.enabled!==!1){if(a.auth.enabled=!0,!a.auth.endpoints)throw"Valence - valence.auth: No endpoints config found. Make sure in your app's .config() you specify $valence.authProvider.endpoints = {}";if(!a.auth.endpoints.validate)throw"Valence - valence.auth: The Endpoints config item requires a 'validate' property. This is the property we use to validate an identity's active session.";if(!a.auth.endpoints.login)throw"Valence - valence.auth: The Endpoints config item requires a 'login' property. This is the property we use to create a user auth identity.";if(!a.auth.endpoints.logout)throw"Valence - valence.auth: The Endpoints config item requires a 'logout' property. This is the property we use to destroy a user auth identity.";return a.auth.enabled&&a.route.addHook(h),a}}]),valenceApp.service("acl",["valence","route","model","$q","$location",function(a,b,c,d,e){function f(b){for(var c=0;c<a.roles.length;c++)if(a.roles[c].name==b)return a.roles[c]}var g=a.acl.identity.model||null,h=a.acl.identity.default||{name:"Anonymous",role:"guest"};return a.acl.getIdentity=function(){var a=d.defer();return g?c.get(g).then(function(b){a.resolve(b)},function(){a.resolve(h)}):a.resolve(h),a.promise},a.acl.clearIdentity=function(){var b=d.defer();return a.store.remove({model:g}).then(function(){b.resolve(h)},function(a){b.reject(a)}),b.promise},a.acl.checkRoles=function(b,c){var g,h=!1,i=0;!function j(){if(b[i])g=f(b[i]),g.fn(a,d).then(function(){h=!0},function(){return i++,j()});else if(i===b.length&&!h){if(c.redirect&&c.redirect.fail)return e.path("previous"===c.redirect.fail?e.path()===a.route.previous?"/":a.route.previous:c.redirect.fail);return}}()},a.acl.accessHook=function(b,c){c[b].access&&c[b].access.roles&&(c[b].access.roles.constructor!==Array&&(c[b].access.roles=[c[b].access.roles]),a.acl.checkRoles(c[b].access.roles,c[b].access))},a.route.addHook(a.acl.accessHook),a}]),valenceApp.service("route",["valence","loader","$rootScope","$location","$q","$routeParams","$route",function(a,b,c,d,e,f,g){function h(a){var b=[];a=a.split("/");for(var c=0;c<a.length;c++)""!==a[c]&&b.push(a[c]);return b}function i(){var a=e.defer(),b=0,c=setInterval(function(){Object.keys(f).length?(clearInterval(c),a.resolve(f)):(b+=300,b>=1e3&&(clearInterval(c),a.resolve(null)))},300);return a.promise}function j(a){var c,e,f=h(d.path()),j=!1;b.run(),c=a?[a]:k,i().then(function(a){for(var b in g.routes){var i=0,k=0,l=!1,m=0,n=0,o=!1;if(b===d.path())c.forEach(function(a){a(b,g.routes)});else if(e=h(b),e.length===f.length&&a){for(var p=0;p<e.length;p++)if(null!==e[p].match(":"))for(var q in a)i++,null!==e[p].match(q)&&k++;else m++,e[p]===f[p]&&n++;i&&k&&i===k&&(l=!0),m&&n&&m===n&&(o=!0),l&&o&&!j&&(j=!0,c.forEach(function(a){a(b,g.routes)}))}}})}var k=[];return a.route.redirect=function(a,b){var c=e.defer();return b=b||{},a.opts.HTTP&&a.opts.HTTP[a.action]&&a.opts.HTTP[a.action].redirect?a.data&&a.data.status&&(a.opts.HTTP[a.action].redirect[a.data.status]?(d.path(a.opts.HTTP[a.action].redirect[a.data.status]),c.resolve({})):c.reject(a)):c.resolve(b),c.promise},a.route.addHook=function(a){k.push(a)},a.route.parseRoutes=j,c.$on("$locationChangeSuccess",function(b,c,d){a.route.previous=d.split("#")[1],j()}),a.route}]);var app=angular.module("valenceDemoApp",["ngRoute","valence"]);app.config(["$routeProvider","valenceProvider","$sceProvider",function(a,b,c){c.enabled(!1),b.api=api,b.loader.loader="#loader",b.loader.content="#transition-wrapper",b.loader.enabled=!0,b.storageEngine={primary:"memory",fallbackToMemory:!0},b.acl.identity.model="user",b.auth.endpoints={login:{URL:api+"/session",requires:["username","password"],method:"POST",success:"/"},logout:{URL:api+"/session",method:"DELETE",success:"/"},validate:{URL:api+"/session",method:"GET",name:"token"}},b.auth.enabled=!0,a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl",auth:!1}).when("/login",{templateUrl:"views/login.html",controller:"LoginCtrl",auth:{redirect:{success:"/"}}}).when("/sign-up",{templateUrl:"views/sign-up.html",controller:"SignUpCtrl",auth:!1}).when("/blog",{templateUrl:"views/blog.html",controller:"BlogCtrl",model:["posts"]}).when("/blog/new",{templateUrl:"views/post/new.html",controller:"PostCtrl",auth:{redirect:{fail:"/login"}}}).when("/blog/:post_id",{templateUrl:"views/post.html",controller:"PostCtrl",model:["post"],auth:!1}).when("/blog/:post_id/edit",{templateUrl:"views/post/edit.html",controller:"PostCtrl",model:"post",auth:{redirect:{fail:"/login"}},access:{roles:["admin","author"],redirect:{fail:"previous"}}}).when("/authors/:author_id",{templateUrl:"views/authors.html",controller:"AuthorsCtrl",model:["authors","author_posts"]}).when("/guides",{templateUrl:"views/guides.html",controller:"GuidesCtrl"}).when("/docs",{templateUrl:"views/docs.html",controller:"DocsCtrl"}).when("/slides",{templateUrl:"views/slide.html",controller:"SlideCtrl"}).when("/slides/:slide",{templateUrl:"views/slide.html",controller:"SlideCtrl"}).when("/404",{templateUrl:"views/404.html",controller:"MainCtrl"}).when("/500",{templateUrl:"views/500.html",controller:"MainCtrl"}).otherwise({redirectTo:"/404"})}]),app.run(["$route","valence",function(){}]),app.controller("MainCtrl",["$scope","model","$rootScope",function(){}]),app.controller("BlogCtrl",["$scope","$location","valence","$rootScope",function(a,b,c,d){c.scope("posts",a),a.posts=[],a.predicate="-created",d.excerpt=a.excerpt=function(a){return a?a.slice(0,250)+"...":void 0},a.formatDate=function(a){var b=new Date(1e3*a),c=function(a){var b={0:"Sunday",1:"Monday",2:"Tuesday",3:"Wednesday",4:"Thursday",5:"Friday",6:"Saturday"};return b[a.getDay()]}(b),d=b.getHours(),e=b.getMinutes();return c+","+d+":"+e}}]),app.controller("PostCtrl",["$scope","valence","$location",function(a,b,c){b.scope(["post","comments"],a),a.post=[],a.edit=null===c.path().match("/edit")?c.path()+"/edit":c.path(),c.path().match("new")||b.get("comments").then(function(b){a.comments=b}),a.saveComment=function(c,d){b.acl.getIdentity().then(function(b){d.author=b.name,b._id?d.user_id=b._id:"",a.save(c,{data:d}).then(function(){a.comment=""},function(){console.log("isErrorings?")})})},a.createPost=function(d){a.save("posts",{data:d}).then(function(a){b.get("posts",{opts:{forceFetch:!0}}).then(function(){c.path("/blog/"+a[0]._id)})})},a.updatePost=function(a){b.put("posts",{data:a}).then(function(a){c.path("/blog/"+a[0]._id)})}}]),app.controller("LoginCtrl",["$scope","valence","$rootScope",function(a,b,c){a.login=function(){b.auth.login(a.creds).then(function(a){c.identity=a})}}]),app.controller("GuidesCtrl",["$scope","$rootScope","$sce",function(a,b,c){console.log(c.isEnabled()),a.title="First Steps";var d="http://foo.com/"+a.title.toLowerCase().replace(/ /gi,"-");a.videoUrl=c.trustAsResourceUrl(d),a.showVideo=function(b){a.title=b.target.textContent,a.videoUrl="http://foo.com/"+a.title.toLowerCase().replace(/ /gi,"-")}}]),app.controller("SignUpCtrl",["$scope","valence","$location","$rootScope",function(a,b,c,d){a.message="",a.signUp=function(){b.post("users",{data:a.new_user,opts:{localize:!1,refreshModel:!1}}).then(function(){console.log(a.new_user),b.auth.login(a.new_user).then(function(a){d.identity=a},function(b){a.message=b.data})})}}]),app.controller("AuthorsCtrl",["$scope","valence",function(a,b){b.scope("author_posts",a),a.author_posts=[],a.excerpt=function(a){return a?a.slice(0,250)+"...":void 0}}]),app.controller("DocsCtrl",["$scope",function(){}]),valence.model("posts",{hasMany:{model:"post"},standAlone:"blog",HTTP:{PUT:{url:"posts",params:{post_id:"post_id"}},GET:{url:"posts"}},refreshModel:!1,normalize:function(a,b,c,d){var e=d.defer();return a.get("users",{opts:{HTTP:{GET:{url:"users",params:null}}}}).then(function(a){c.forEach(function(b){a.forEach(function(a){a._id===b.author_id&&(b.avatar=a.avatar)})}),e.resolve(c)}),e.promise}}),valence.model("post",{belongsTo:{model:"posts",type:Object,by:{post_id:"_id"}},HTTP:{GET:{url:"posts",params:{post_id:"_id"},redirect:{404:"/404",500:"/500"}}},type:Object,normalize:function(a,b,c,d){var e=d.defer();return a.get("users",{opts:{HTTP:{GET:{url:"users?_id="+c.author_id}}},localize:!1,forceFetch:!0,type:Object}).then(function(a){c.avatar=a[0].avatar,e.resolve(c)}),e.promise}}),valence.model("users",{HTTP:{GET:{url:"users",params:null}},localize:!1,normalize:function(a,b,c,d){var e=d.defer(),f=c;return"POST"===b.action&&(f=c[0]),e.resolve(f),e.promise}}),valence.model("user",{HTTP:{GET:{auth:!0}},normalize:function(a,b,c,d){var e=d.defer(),f={};return f=c[0],e.resolve(f),e.promise}}),valence.model("authors",{belongsTo:{type:Object,model:"users",by:{author_id:"_id"}},HTTP:{GET:{url:"users"}}}),valence.model("author_posts",{belongsTo:{model:"posts",type:Array,by:{author_id:"author_id"}},HTTP:{GET:{url:"posts",params:{author_id:"_id"}},POST:{url:"posts",data:{author_id:"_id"}}},normalize:function(a,b,c,d){var e=d.defer();return a.get("users",{opts:{HTTP:{GET:{url:"users?_id="+c[0].author_id}}},localize:!1,forceFetch:!0,type:Object}).then(function(a){c[0].avatar=a[0].avatar,e.resolve(c)}),e.promise}}),valence.model("comments",{HTTP:{GET:{url:"comments",params:{post_id:"post_id"}},POST:{url:"comments",data:{post_id:"post_id"}}},belongsTo:{model:"post",type:Array,by:{post_id:"post_id"}},normalize:function(a,b,c,d){var e=d.defer(),f=0;return function g(){c[f]&&c[f].comment_id?!function a(b,d){for(var e=0;e<b.length;e++)d&&b[e]._id===d.comment_id?(b[e].comments||(b[e].comments=[]),b[e].comments.push(d),c.splice(f,1),g()):b[e].comments&&b[e].comments.length&&a(b[e].comments,d)}(c,c[f],f):c[f+1]?(f++,g()):e.resolve(c)}(),e.promise},type:Array}),valence.role("author",function(a,b){var c=b.defer();return a.get("post").then(function(b){a.acl.getIdentity().then(function(a){b.author_id===a._id?(console.log("pass"),c.resolve()):c.reject()})}),c.promise}),valence.role("admin",function(a,b){var c=b.defer();return a.acl.getIdentity().then(function(a){a.role&&"admin"===a.role?c.resolve():c.reject()}),c.promise}),app.directive("datanav",["$compile",function(){return{scope:!1,restrict:"E",templateUrl:view_prefix+"/scripts/directives/templates/nav.html",controller:["$scope","$element","$attrs","$rootElement","$rootScope","valence",function(a,b,c,d,e,f){a.getNavTemplate=function(){return"scripts/directives/templates/"+(f.auth.isValidated?"logged-in_nav.html":"logged-out_nav.html")},f.auth.validate().then(function(a){e.identity=a}),a.logout=function(){f.auth.logout().then(function(a){e.identity=a})}}]}}]),app.directive("comments",["$parse","$compile",function(a,b){return{restrict:"A",scope:{comments:"="},templateUrl:view_prefix+"/views/comments.html",replace:!1,transclude:!0,controller:["$scope","$element","$attrs","valence",function(a,b,c,d){a.showReply=!1,a.submitReply=function(a,b){var c={};c.post_id=a.post_id,c.comment_id=a._id,c.body=b,d.post("comments",{data:c}).then(function(){})}}],compile:function(a,c,d){var e,f=a.contents().remove();return function(a,c){e||(e=b(f,d)),e(a,function(a){c.append(a)})}}}}]);