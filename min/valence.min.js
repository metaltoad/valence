"use strict";var valenceApp=angular.module("valence",[]);valenceApp.run(["route","auth","acl","model",function(){}]),window.valence={},valence.models=[],valence.model=function(model,fields){for(var match=!1,obj={},i=0;i<valence.models.length;i++)valence.models[i].name===model&&(match=!0);if(!match){obj.name=model;for(var prop in fields)obj[prop]=fields[prop];valence.models.push(obj)}},valence.roles=[],valence.role=function(role,fn){for(var i=0;i<valence.roles.length;i++)if(valence.roles[i].name===role)throw"Valence - ACL: You cannot register two or more roles with the same name.";valence.roles.push({name:role,fn:fn})},valenceApp.provider("valence",{loader:{},models:[],roles:[],cloud:{},store:{},acl:{identity:{}},auth:{endpoints:{login:{},logout:{},validate:{}}},route:{},storageEngine:{primary:"localStorage",fallbackToMemory:!0},$get:function(){return this.model=valence.model,this.models=valence.models,this.role=valence.role,this.roles=valence.roles,valence=this,this}}),valenceApp.service("model",["valence","cloud","store","loader","auth","$route","$rootScope","$location","$rootElement","$q","$routeParams","route",function(valence,cloud,store,loader,auth,$route,$rootScope,$location,$rootElement,$q,$routeParams){function getModelConfig(model){for(var config,i=0;i<valence.models.length;i++)valence.models[i].name===model&&(config=valence.models[i]);if(!config&&opts)config=opts;else if(!config&&!opts)throw"Valence - model for ["+model+"] not found. Make sure to declare one through valence.model()";return config}function merge(src,ext){for(var p in ext)try{src[p]=ext[p].constructor===Object?Model.fn.merge(src[p],ext[p]):ext[p]}catch(e){src[p]=ext[p]}return src}function apply(args){for(var scope,i=0;i<valence.models.length;i++)valence.models[i].name===args.model&&(args.scope=valence.models[i].scope);scope=args.scope||$rootScope,data=serialize(args.opts,args.data),args.opts.normalize?args.opts.normalize(data,args,$q).then(function(normalized){scope[args.model]=data,args.def.resolve(normalized),loader.loaded(args.model)}):(scope[args.model]=data,args.def.resolve(data),loader.loaded(args.model))}function serialize(opts,data){var returnData,type=Array,castMappings={Array:function(data){return[data]},Object:function(data){var obj={};if(data.constructor!==Array&&(data=[data]),1===data.length)obj=data[0];else for(var i=0;i<data.length;i++)obj[i]=data[i];return obj},String:function(data){return data.toString()},Boolean:function(data){return!!data}};return type=getSerializeType(opts.type?opts.type:opts.belongsTo&&opts.belongsTo.type?opts.belongsTo.type:type),null===data.constructor.toString().match(type)?castMappings[type]&&(returnData=castMappings[type](data)):returnData=data,returnData}function getSerializeType(type){for(var supportedTypes=["Array","String","Boolean","Object"],returnType=!1,i=0;i<supportedTypes.length;i++)type.toString().match(supportedTypes[i])&&(returnType=supportedTypes[i]);return returnType}function modelHook(key,path){if(path[key].model){path[key].model.constructor!==Array&&(path[key].model=[path[key].model]);for(var m=0;m<path[key].model.length;m++)for(var i=0;i<valence.models.length;i++)valence.models[i].name===path[key].model[m]&&valence.get(valence.models[i].name,valence.models[i])}else loader.finish()}valence.buildParamQuery=function(opts){var predicate,query={};if(opts&&(opts.by?predicate=["by"]:opts.params&&!opts.data?predicate=["params"]:opts.data&&!opts.params?predicate=["data"]:opts.params&&opts.data&&(predicate=["params","data"])),predicate)for(var i=0;i<predicate.length;i++)for(var param in opts[predicate[i]])query[predicate[i]]||(query[predicate[i]]={}),$routeParams[param]&&("params"==predicate[i]?query[predicate[i]][param]=$routeParams[param]:query[predicate[i]][opts[predicate[i]][param]]=$routeParams[param]),opts.useRouteParams===!1&&(query[predicate[i]][param]=opts[predicate[i]][param]);return Object.keys(query).length?query:!1};var Model=function(action,args){var self=this,config={loader:!0,belongsTo:null,hasMany:null,localize:!0,forceFetch:!1,ignoreDefaultConfig:!1,storeInMemory:!1,refreshModel:!0,auth:!1};this.opts=args.opts?args.opts.ignoreDefaultConfig?args.opts:merge(config,merge(getModelConfig(args.model),args.opts)):merge(config,getModelConfig(args.model)),this.args={},this.args.action=action,this.args.model=args.model,this.args.opts=this.opts,this.args.data=args.data,this.args.def=args.def,this.strategeries=[],this.sequences={},this.sequences.GET={},this.sequences.GET.save=[{fn:store.set,fail:self.halt,pass:self.conquer,overriden:self.conquer,overrides:[!self.opts.localize],name:"store.set"}],this.sequences.GET.cloud=[{fn:cloud.get,fail:self.halt,pass:this.sequences.GET.save,name:"cloud.get"}],this.sequences.GET.store=[{fn:store.get,fail:self.sequences.GET.cloud,pass:self.conquer,overrides:[self.opts.forceFetch],name:"store.get"}],this.sequences.GET.init=[{fn:loader.run,pass:self.sequences.GET.store,overrides:[!valence.loader.enabled],name:"loader.run"}],this.sequences.POST={},this.sequences.POST.store=[{fn:store.set,fail:self.halt,pass:self.conquer,overriden:self.conquer,overrides:[!self.opts.localize],name:"store.set"}],this.sequences.POST.fetch=[{fn:cloud.get,fail:self.halt,pass:this.sequences.POST.store,name:"cloud.get",overriden:this.sequences.POST.store,overrides:[!self.opts.refreshModel]}],this.sequences.POST.cloud=[{fn:cloud.set,fail:self.halt,pass:this.sequences.POST.fetch,name:"cloud.set"}],this.sequences.POST.init=[{fn:loader.run,pass:self.sequences.POST.cloud,overrides:[!valence.loader.enabled],name:"loader.run"}],this.sequences.PUT=this.sequences.POST,this.sequences.DELETE={},this.sequences.DELETE.store=[{fn:store.set,fail:self.halt,pass:self.conquer,overriden:self.conquer,overrides:[!self.opts.localize],name:"store.set"}],this.sequences.DELETE.fetch=[{fn:cloud.get,fail:self.halt,pass:this.sequences.DELETE.store,name:"cloud.get"}],this.sequences.DELETE.cloud=[{fn:cloud.remove,fail:self.halt,pass:this.sequences.DELETE.fetch,name:"cloud.set"}],this.sequences.DELETE.init=[{fn:loader.run,pass:self.sequences.DELETE.cloud,overrides:[!valence.loader.enabled],name:"loader.run"}],this.advance()};return Model.prototype.advance=function(){var strategy,self=this;strategy=this.sequences[this.args.action].init,function fire(strategy,idx){if(idx=idx||0,strategy=strategy[idx],strategy.overrides)Overrides:for(var j=0;j<strategy.overrides.length;j++)if(strategy.overrides[j]){if(strategy.overriden)return strategy.overriden.constructor===Function?strategy.overriden(self.args):fire(strategy.overriden);break Overrides}strategy.fn(self.args).then(function(data){return data&&(self.args.data=data),strategy.pass?strategy.pass.constructor===Function?strategy.pass(self.args):fire(strategy.pass):strategy[idx+1]?fire(strategy,idx+1):void 0},function(data){return strategy.fail?strategy.fail.constructor===Function?strategy.fail(self.args,data):fire(strategy.fail):strategy[idx+1]?fire(strategy,idx+1):void 0})}(strategy)},Model.prototype.conquer=function(args){apply(args)},Model.prototype.halt=function(args,data){args.def.reject({args:args,data:data}),loader.halt()},valence.get=function(model,args){var def=$q.defer();return args=args||{},new Model("GET",{model:model,opts:args.opts,data:args.data,def:def}),def.promise},valence.put=function(model,args){var def=$q.defer();return new Model("PUT",{model:model,opts:args.opts,data:args.data,def:def}),def.promise},valence.post=function(model,args){var def=$q.defer();return new Model("POST",{model:model,opts:args.opts,data:args.data,def:def}),def.promise},valence.remove=function(model,args){var def=$q.defer();return new Model("DELETE",{model:model,opts:args.opts,data:args.data,def:def}),def.promise},valence.scope=function(model,scope){model=model.constructor===Array?model:[model];for(var m=0;m<model.length;m++)for(var i=0;i<valence.models.length;i++)valence.models[i].name===model[m]&&(valence.models[i].scope=scope)},$rootScope.save=valence.post,$rootScope.update=valence.put,$rootScope.remove=valence.remove,valence.route.addHook(modelHook),valence}]),valenceApp.service("store",["valence","$q",function(valence,$q){var store=window.valenceStore={},Adapters={};Adapters.localStorage={get:function(){var data,store=JSON.parse(window.localStorage.valenceStore);return store.hasOwnProperty(args.model)&&(data=store[args.model]),data},set:function(model,data){var store=JSON.parse(window.localStorage.valenceStore);return store[args.model]=data,window.localStorage.valenceStore=JSON.stringify(store),this.get(args.model)},remove:function(model){var store=JSON.parse(window.localStorage.valenceStore);return store.hasOwnProperty(model)?(delete store[args.model],window.localStorage.valenceStore=JSON.stringify(store),!0):!1}},Adapters.memory={get:function(model){var data;return store.hasOwnProperty(model)&&(data=store[model]),data},set:function(model,data){return store[model]=data,this.get(model)},remove:function(model){return store.hasOwnProperty(model)?(delete store[model],!0):!1}},valence.store={};var engine=valence.storageEngine&&valence.storageEngine.primary?valence.storageEngine.primary:valence.storageEngine&&valence.storageEngine.fallbackToMemory?"memory":window.localStorage?"localStorage":[];return"localStorage"===engine&&(valence.storageEngine.fetchOnReload||void 0===window.localStorage.valenceStore)&&(window.localStorage.valenceStore=JSON.stringify({})),valence.store.get=function(args){var result,def=$q.defer(),data=Adapters[engine].get(args.model),qLen=0,mLen=0;if((args.opts&&args.opts.localize===!1||args.opts.forceFetch===!0)&&def.reject("store"),data)if(args.opts.belongsTo&&(args.query=valence.buildParamQuery(args.opts.belongsTo)),args.query){for(var type in args.query)for(var param in args.query[type])qLen++;if(data.constructor===Array){result=[];for(var i=0;i<data.length;i++){if(data[i].constructor===Object)for(var type in args.query)for(var param in args.query[type])data[i][param]&&data[i][param]==args.query[type][param]&&(mLen++,qLen&&mLen&&qLen===mLen&&-1===result.indexOf(data[i])&&result.push(data[i]));mLen=0}result.length?def.resolve(result):def.reject(result)}else if(data.constructor===Object){for(var type in args.query)for(var param in args.query[type])qLen++,data[param]&&data[param]===args.query[type][param]&&mLen++;qLen&&mLen&&qLen===mLen?def.resolve(data):def.reject(data)}}else def.resolve(data);else def.reject(!1);return def.promise},valence.store.set=function(args){var res,def=$q.defer();return args.opts&&args.opts.localize===!1?def.resolve(args.data):(res=Adapters[engine].set(args.model,args.data),res?def.resolve(res):def.reject(!1)),def.promise},valence.store.remove=function(args){var def=$q.defer();return Adapters[engine].remove(args.model)?def.resolve(!0):def.reject(!1),def.promise},valence.store}]),valenceApp.service("loader",["valence","$q",function(valence,$q){return valence.loader.queue=[],valence.loader.loaderStarted=null,valence.loader.loaderClasses={hide:valence.loader.classes&&valence.loader.classes.hide?valence.loader.classes.hide:"ngLoader-hidden",show:valence.loader.classes&&valence.loader.classes.show?valence.loader.classes.show:"ngLoader-visible"},valence.loader.loaderCollection=[],valence.loader.contentCollection=[],valence.loader.minLoaderDisplayTime=1e3,valence.loader.run=function(model,opts){var data,def=$q.defer(),content=valence.loader.content,loaderElem=valence.loader.loader;if(valence.loader.enabled){model&&(model=model.model||model,opts=model.opts||opts,data=model.data,valence.loader.queue.push({name:model,opts:opts}),model.loader&&(opts.loader.content&&(content=opts.loader.content),opts.loader.loader&&(loaderElem=opts.loader.loader))),valence.loader.loaderStarted||(valence.loader.loaderStarted=(new Date).getTime()),content=document.querySelectorAll(content).length?document.querySelectorAll(content):function(){throw"valence - ngLoader - It was requested that ["+content+"] be hidden when initiating the loader, however, no elements could be found in the DOM"}(),loaderElem=document.querySelectorAll(loaderElem).length?document.querySelectorAll(loaderElem):function(){throw"valence - ngLoader - It was requested that ["+loaderElem+"] be hidden when initiating the loader, however, no elements could be found in the DOM"}();for(var i=0;i<content.length;i++)content[i].classList.add(valence.loader.loaderClasses.hide),content[i].classList.remove(valence.loader.loaderClasses.show),valence.loader.contentCollection.push(content[i]);for(var i=0;i<loaderElem.length;i++)loaderElem[i].classList.add(valence.loader.loaderClasses.show),loaderElem[i].classList.remove(valence.loader.loaderClasses.hide),valence.loader.loaderCollection.push(loaderElem[i])}return def.resolve(data),def.promise},valence.loader.loaded=function(model){var newQueue=[];if(!model)throw'valence - ngLoader - valence.loader.loaded must be passed a model so it knows how "done" it is and when to stop the loader.';for(var i=0;i<valence.loader.queue.length;i++)model!==valence.loader.queue[i].name&&newQueue.push(valence.loader.queue[i]);valence.loader.queue=newQueue,valence.loader.finish()},valence.loader.finish=function(){var finishedTime,self=valence.loader;valence.loader.queue.length||(finishedTime=(new Date).getTime(),finishedTime-valence.loader.loaderStarted>=valence.loader.minLoaderDisplayTime?valence.loader.wrapUp():setTimeout(function(){self.wrapUp()},self.minLoaderDisplayTime-(finishedTime-self.loaderStarted)),valence.loader.loaderStarted=null)},valence.loader.wrapUp=function(){valence.loader.contentCollection.length||(valence.loader.contentCollection=document.querySelectorAll(valence.loader.content).length?document.querySelectorAll(valence.loader.content):function(){throw"valence - ngLoader - It was requested that ["+valence.loader.content+"] be hidden when initiating the loader, however, no elements could be found in the DOM"}()),valence.loader.loaderCollection.length||(valence.loader.loaderCollection=document.querySelectorAll(valence.loader.loader).length?document.querySelectorAll(valence.loader.loader):function(){throw"valence - ngLoader - It was requested that ["+valence.loader.loader+"] be hidden when initiating the loader, however, no elements could be found in the DOM"}());for(var i=0;i<valence.loader.loaderCollection.length;i++)valence.loader.loaderCollection[i].classList.remove(valence.loader.loaderClasses.show),valence.loader.loaderCollection[i].classList.add(valence.loader.loaderClasses.hide);for(var i=0;i<valence.loader.contentCollection.length;i++)valence.loader.contentCollection[i].classList.remove(valence.loader.loaderClasses.hide),valence.loader.contentCollection[i].classList.add(valence.loader.loaderClasses.show);valence.loader.loaderCollection=[],valence.loader.contentCollection=[]},valence.loader.halt=function(){valence.loader.queue=[],valence.loader.finish()},valence.loader}]),valenceApp.service("cloud",["valence","$http","$q",function(valence,$http,$q){var baseEarl=valence.api+"/";return valence.cloud.get=function(args){var def=$q.defer(),httpOpts={};return httpOpts.method="GET",httpOpts.url=baseEarl+args.model,httpOpts.params=null,args.opts.HTTP&&args.opts.HTTP.GET?(args.opts.HTTP.GET.params?args.query=valence.buildParamQuery(args.opts.HTTP.GET):args.opts.belongsTo&&(args.query=valence.buildParamQuery(args.opts.belongsTo)),args.opts.HTTP.GET.url&&(httpOpts.url=baseEarl+args.opts.HTTP.GET.url),args.opts.HTTP.GET.auth&&!valence.auth.isValidated&&def.reject()):args.opts.belongsTo&&(args.query=valence.buildParamQuery(args.opts.belongsTo)),args.query&&(httpOpts.params=args.query.params||args.query.by),$http(httpOpts).success(function(data){def.resolve(data)}).error(function(data,status,headers,config){def.reject({data:data,status:status,headers:headers,config:config})}),def.promise},valence.cloud.set=function(args){var action,def=$q.defer(),httpOpts={};if(action=args.action.toUpperCase(),httpOpts.method=action,httpOpts.url=baseEarl+args.model,httpOpts.params=null,args.opts.HTTP&&args.opts.HTTP[action]&&(args.query=valence.buildParamQuery(args.opts.HTTP[action]),args.opts.HTTP[action].url&&(httpOpts.url=baseEarl+args.opts.HTTP[action].url)),args.query&&args.query.params&&(httpOpts.params=args.query.params),httpOpts.data=args.data,args.query&&args.query.data)for(var key in args.query.data)httpOpts.data[key]=args.query.data[key];return $http(httpOpts).success(function(data){def.resolve(data)}).error(function(data,status,headers,config){def.reject({data:data,status:status,headers:headers,config:config})}),def.promise},valence.cloud}]),valenceApp.service("auth",["valence","$rootScope","$location","$route","$http","$routeParams","$q","route",function(valence,$rootScope,$location,$route,$http,$routeParams,$q){function authHook(key,path){var redirect;(path[key].auth||valence.auth.every)&&(path[key].auth&&path[key].auth.redirect&&(redirect=path[key].auth.redirect),valence.auth.validate(path[key],redirect))}valence.auth.every=!0,valence.auth.isValidated=null,valence.auth.lastValidated=null,valence.auth.validateInterval=1e4,valence.auth.firstVisit=!0,valence.auth.token=valence.auth.endpoints.validate.name||null;var storage=valence.auth.storage||"localStorage";if(valence.auth.validate=function(route,redirect){var self=this,def=$q.defer();if((new Date).getTime()-valence.auth.lastValidated>valence.auth.validateInterval||null===valence.auth.lastValidated)self.getToken()&&!$http.defaults.headers.common.authorization&&($http.defaults.headers.common.authorization="Bearer "+self.getToken()),$http({method:valence.auth.endpoints.validate.method,url:valence.auth.endpoints.validate.URL,withCredentials:!0}).success(function(){self.postFlow({isValidated:!0,lastValidated:(new Date).getTime()}),valence.acl.getIdentity().then(function(identity){def.resolve(identity)}),route?redirect&&redirect.success&&$location.path(redirect.success):valence.route.parseRoutes(authHook)}).error(function(){redirect&&redirect.fail&&$location.path(redirect.fail),self.postFlow({isValidated:!1,lastValidated:(new Date).getTime()}),valence.acl.getIdentity().then(function(identity){def.reject(identity)})});else{if(!route)return valence.route.parseRoutes(authHook);valence.auth.isValidated&&redirect&&redirect.success?$location.path(redirect.success):!valence.auth.isValidated&&redirect&&redirect.fail&&$location.path(redirect.fail),valence.acl.getIdentity().then(function(identity){def.reject(identity)})}return def.promise},valence.auth.login=function(userData){var self=this,def=$q.defer();if(!userData)throw"Valence - Auth - you must provide credentials to this method [login].";return $http({method:valence.auth.endpoints.login.method,url:valence.auth.endpoints.login.URL,data:userData}).success(function(data){var token=data[valence.auth.token]?data[valence.auth.token]:data;self.postFlow({isValidated:!0,setToken:token}),valence.acl.getIdentity().then(function(identity){def.resolve(identity)}),valence.auth.endpoints.login.success&&$location.path(valence.auth.endpoints.login.success)}).error(function(){self.postFlow({isValidated:!1,setToken:null}),valence.acl.getIdentity().then(function(identity){def.resolve(identity)}),valence.auth.endpoints.login.fail&&$location.path(valence.auth.endpoints.fail)}),def.promise},valence.auth.logout=function(){var self=this,def=$q.defer();return self.postFlow({isValidated:!1,setToken:null}),$location.path(valence.auth.endpoints.logout.success),valence.acl.clearIdentity().then(function(identity){def.resolve(identity)}),def.promise},valence.auth.postFlow=function(opts){var self=this;for(var prop in opts)self[prop]&&self[prop].constructor===Function?self[prop](opts[prop]):self[prop]=opts[prop]},valence.auth.setToken=function(token){var self=this;"localStorage"===storage?window.localStorage[valence.auth.token]=token:"sessionStorage"===storage&&(window.sessionStorage[valence.auth.token]=token),token?$http.defaults.headers.common.authorization="Bearer "+self.getToken():delete $http.defaults.headers.common.authorization},valence.auth.getToken=function(){var token=null;return"localStorage"===storage?token=window.localStorage[valence.auth.token]:"sessionStorage"===storage&&(token=window.sessionStorage[valence.auth.token]),token},valence.auth.enabled!==!1){if(valence.auth.enabled=!0,!valence.auth.endpoints)throw"Valence - valence.auth: No endpoints config found. Make sure in your app's .config() you specify $valence.authProvider.endpoints = {}";if(!valence.auth.endpoints.validate)throw"Valence - valence.auth: The Endpoints config item requires a 'validate' property. This is the property we use to validate an identity's active session.";if(!valence.auth.endpoints.login)throw"Valence - valence.auth: The Endpoints config item requires a 'login' property. This is the property we use to create a user auth identity.";if(!valence.auth.endpoints.logout)throw"Valence - valence.auth: The Endpoints config item requires a 'logout' property. This is the property we use to destroy a user auth identity.";return valence.auth.enabled&&valence.route.addHook(authHook),valence}}]);